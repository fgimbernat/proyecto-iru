<% content_for :page_title, "Segmentación" %>

<div class="px-4 sm:px-6 lg:px-8 py-8" x-data="{ 
  showNewSegmentationModal: false,
  newSegmentationName: '',
  newSegmentationVisibility: 'all'
}">
  <!-- Header -->
  <div class="flex items-center justify-between mb-10">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Segmentación</h1>
      <p class="mt-1 text-sm text-gray-500">Organiza las categorías de tu equipo</p>
    </div>
    
    <button @click="showNewSegmentationModal = true" class="inline-flex items-center px-5 py-2.5 border border-transparent rounded-xl text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Nueva segmentación
    </button>
  </div>

  <!-- Modal Nueva Segmentación -->
  <div x-show="showNewSegmentationModal" 
       x-cloak
       class="fixed inset-0 z-50 overflow-y-auto" 
       aria-labelledby="modal-title" 
       role="dialog" 
       aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div x-show="showNewSegmentationModal"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"
           class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" 
           @click="showNewSegmentationModal = false"></div>

      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

      <div x-show="showNewSegmentationModal"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
           x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
           x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
           class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        
        <div class="bg-white px-6 pt-6 pb-4">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Nueva segmentación</h3>
          
          <%= form_with url: admin_segmentation_segmentations_path, method: :post do |f| %>
            <div class="mb-4">
              <label for="segmentationName" class="block text-sm font-medium text-gray-700 mb-2">
                Nombre
              </label>
              <%= f.text_field :name, id: 'segmentationName', 'x-model': 'newSegmentationName', class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Ingresa el nombre", required: true %>
            </div>

            <div class="mb-4">
              <label for="segmentationVisibility" class="block text-sm font-medium text-gray-700 mb-2">
                Visibilidad
                <svg class="inline w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </label>
              <div class="relative">
                <%= f.select :visibility, [['Todos', 'all'], ['Propio usuario y administradores', 'own_and_admins'], ['Sólo administradores', 'admins_only']], {}, id: 'segmentationVisibility', 'x-model': 'newSegmentationVisibility', class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none bg-white pr-10" %>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>
              <p class="mt-2 text-xs text-gray-500">Determina quién verá este campo en el perfil del usuario</p>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex items-center justify-end space-x-3 -mx-6 -mb-4 mt-6">
              <button @click="showNewSegmentationModal = false; newSegmentationName = ''; newSegmentationVisibility = 'all'" 
                      type="button" 
                      class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                Cancelar
              </button>
              
              <%= f.submit "Guardar", class: "px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid dinámico de segmentaciones -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
    <% @segmentations.each do |segmentation| %>
      <div class="bg-white border border-gray-200 rounded-xl shadow-md hover:shadow-xl hover:border-blue-300 transition-all duration-200" 
           x-data="{ menuOpen: false, showEditModal: false, editName: '<%= segmentation.name %>', editVisibility: '<%= segmentation.visibility %>' }">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-white">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <h3 class="text-base font-bold text-gray-900"><%= segmentation.name %></h3>
                <% if segmentation.is_system? %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-semibold bg-blue-50 text-blue-700 border border-blue-200">
                    <svg class="w-2.5 h-2.5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    Sistema
                  </span>
                <% end %>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                <%= segmentation.visibility == 'all' ? 'Todos' : segmentation.visibility == 'own_and_admins' ? 'Propio usuario y administradores' : 'Sólo administradores' %>
              </p>
            </div>
            
            <!-- Menú de opciones -->
            <div class="relative flex-shrink-0">
              <button @click="menuOpen = !menuOpen" class="p-1.5 text-gray-400 hover:text-gray-700 hover:bg-white rounded-lg transition-all">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                </svg>
              </button>
              
              <div x-show="menuOpen" @click.away="menuOpen = false" x-cloak 
                   class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-200 py-1 z-20"
                   x-transition:enter="transition ease-out duration-100"
                   x-transition:enter-start="transform opacity-0 scale-95"
                   x-transition:enter-end="transform opacity-100 scale-100"
                   x-transition:leave="transition ease-in duration-75"
                   x-transition:leave-start="transform opacity-100 scale-100"
                   x-transition:leave-end="transform opacity-0 scale-95">
                <button @click="showEditModal = true; menuOpen = false" class="w-full flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors text-left">
                  <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  Editar segmentación
                </button>
                
                <% unless segmentation.is_system? %>
                  <div class="border-t border-gray-100 my-1"></div>
                  
                  <%= button_to admin_destroy_segmentation_path(segmentation), 
                    method: :delete,
                    data: { turbo_confirm: "¿Estás seguro de eliminar '#{segmentation.name}' y todos sus ítems?" },
                    class: "w-full flex items-center px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors text-left" do %>
                    <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Eliminar segmentación
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Modal Editar Segmentación -->
        <div x-show="showEditModal" 
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto" 
             aria-labelledby="modal-title" 
             role="dialog" 
             aria-modal="true">
          <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showEditModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" 
                 @click="showEditModal = false"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="showEditModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              
              <div class="bg-white px-6 pt-6 pb-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Editar segmentación</h3>
                
                <%= form_with url: admin_update_segmentation_path(segmentation), method: :patch do |f| %>
                  <div class="mb-4">
                    <label for="editSegmentationName_<%= segmentation.id %>" class="block text-sm font-medium text-gray-700 mb-2">
                      Nombre
                    </label>
                    <%= f.text_field :name, id: "editSegmentationName_#{segmentation.id}", value: segmentation.name, 'x-model': 'editName', class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Ingresa el nombre", required: true %>
                  </div>

                  <div class="mb-4">
                    <label for="editSegmentationVisibility_<%= segmentation.id %>" class="block text-sm font-medium text-gray-700 mb-2">
                      Visibilidad
                      <svg class="inline w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </label>
                    <div class="relative">
                      <%= f.select :visibility, [['Todos', 'all'], ['Propio usuario y administradores', 'own_and_admins'], ['Sólo administradores', 'admins_only']], { selected: segmentation.visibility }, id: "editSegmentationVisibility_#{segmentation.id}", 'x-model': 'editVisibility', class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none bg-white pr-10" %>
                      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                      </div>
                    </div>
                    <p class="mt-2 text-xs text-gray-500">Determina quién verá este campo en el perfil del usuario</p>
                  </div>

                  <div class="bg-gray-50 px-6 py-4 flex items-center justify-end space-x-3 -mx-6 -mb-4 mt-6">
                    <button @click="showEditModal = false; editName = '<%= segmentation.name %>'; editVisibility = '<%= segmentation.visibility %>'" 
                            type="button" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                      Cancelar
                    </button>
                    
                    <%= f.submit "Guardar", class: "px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        
        <div class="p-6 space-y-3 max-h-[500px] overflow-y-auto">
          <% segmentation.segmentation_items.each do |item| %>
            <div x-data="{ editing: false, name: '<%= item.name %>' }" class="group">
              <div x-show="!editing" class="flex items-center justify-between px-5 py-3 bg-gray-50 border-2 border-gray-100 rounded-full hover:border-blue-200 hover:bg-blue-50 transition-all">
                <span class="text-sm text-gray-700 truncate flex-1 font-medium"><%= item.name %></span>
                
                <div class="flex items-center space-x-2 ml-4">
                  <span class="text-sm text-blue-600 font-semibold flex items-center px-2 py-1 bg-blue-50 rounded-full">
                    <%= item.employees.count %>
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </span>
                  
                  <div class="flex items-center space-x-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button @click="editing = true" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-100 rounded-lg transition-all">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                      </svg>
                    </button>
                    <%= button_to admin_destroy_segmentation_item_path(item), method: :delete, data: { confirm: '¿Estás seguro de eliminar este item?' }, class: "p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all" do %>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <div x-show="editing" class="p-3 border-2 border-blue-500 rounded-full bg-blue-50">
                <%= form_with url: admin_update_segmentation_item_path(item), method: :patch, class: "flex items-center space-x-2" do |f| %>
                  <%= f.text_field :name, value: item.name, 'x-model': 'name', class: "flex-1 px-4 py-2 border-2 border-gray-200 rounded-full text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white", placeholder: "Nombre del item" %>
                  <button type="submit" class="p-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                  </button>
                  <button @click="editing = false" type="button" class="p-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <button @click="editingItem = 'new'" x-show="editingItem !== 'new'" class="w-full px-5 py-3.5 border-2 border-dashed border-blue-200 rounded-full text-sm text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-all flex items-center justify-center font-medium shadow-sm hover:shadow-md">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Agregar ítem
          </button>
          
          <div x-show="editingItem === 'new'" class="p-3 border-2 border-blue-500 rounded-full bg-blue-50">
            <%= form_with url: admin_create_segmentation_item_path(segmentation), method: :post, class: "flex items-center space-x-2" do |f| %>
              <%= f.text_field :name, 'x-model': 'newItemName', class: "flex-1 px-4 py-2 border-2 border-gray-200 rounded-full text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white", placeholder: "Nombre del item", required: true %>
              <button type="submit" class="p-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </button>
              <button @click="editingItem = null; newItemName = ''" type="button" class="p-2 text-gray-600 bg-white rounded-lg hover:bg-gray-100">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% content_for :page_title, "Segmentación" %>

<div class="px-4 sm:px-6 lg:px-8 py-8" x-data="{ 
  showNewSegmentationModal: false,
  newSegmentationName: '',
  newSegmentationVisibility: 'all'
}">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-2xl font-semibold text-gray-900">Segmentación</h1>
    
    <button @click="showNewSegmentationModal = true" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors shadow-sm">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Nueva segmentación
    </button>
  </div>

  <!-- Modal Nueva Segmentación -->
  <div x-show="showNewSegmentationModal" 
       x-cloak
       class="fixed inset-0 z-50 overflow-y-auto" 
       aria-labelledby="modal-title" 
       role="dialog" 
       aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div x-show="showNewSegmentationModal"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"
           class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" 
           @click="showNewSegmentationModal = false"></div>

      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

      <div x-show="showNewSegmentationModal"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
           x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
           x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
           class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        
        <div class="bg-white px-6 pt-6 pb-4">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Nueva segmentación</h3>
          
          <%= form_with url: admin_segmentation_segmentations_path, method: :post do |f| %>
            <div class="mb-4">
              <label for="segmentationName" class="block text-sm font-medium text-gray-700 mb-2">
                Nombre
              </label>
              <%= f.text_field :name, id: 'segmentationName', 'x-model': 'newSegmentationName', class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Ingresa el nombre", required: true %>
            </div>

            <div class="mb-4">
              <label for="segmentationVisibility" class="block text-sm font-medium text-gray-700 mb-2">
                Visibilidad
                <svg class="inline w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </label>
              <div class="relative">
                <%= f.select :visibility, [['Todos', 'all'], ['Propio usuario y administradores', 'own_and_admins'], ['Sólo administradores', 'admins_only']], {}, id: 'segmentationVisibility', 'x-model': 'newSegmentationVisibility', class: "block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none bg-white pr-10" %>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>
              <p class="mt-2 text-xs text-gray-500">Determina quién verá este campo en el perfil del usuario</p>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex items-center justify-end space-x-3 -mx-6 -mb-4 mt-6">
              <button @click="showNewSegmentationModal = false; newSegmentationName = ''; newSegmentationVisibility = 'all'" 
                      type="button" 
                      class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                Cancelar
              </button>
              
              <%= f.submit "Guardar", class: "px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid dinámico de segmentaciones -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <% @segmentations.each do |segmentation| %>
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm" x-data="{ editingItem: null, newItemName: '' }">
        <div class="px-5 py-4 border-b border-gray-200">
          <h3 class="text-base font-semibold text-gray-900"><%= segmentation.name %></h3>
          <p class="text-xs text-gray-500 mt-0.5">Visibilidad: <%= segmentation.visibility == 'all' ? 'Todos' : segmentation.visibility == 'own_and_admins' ? 'Propio usuario y administradores' : 'Sólo administradores' %></p>
        </div>
        
        <div class="p-4 space-y-2 max-h-[500px] overflow-y-auto">
          <% segmentation.segmentation_items.each do |item| %>
            <div x-data="{ editing: false, name: '<%= item.name %>' }" class="group">
              <div x-show="!editing" class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <div class="flex items-center flex-1 min-w-0">
                  <span class="text-sm text-gray-900 truncate"><%= item.name %></span>
                  <span class="ml-2 text-xs text-gray-500 flex items-center">
                    <%= item.employees.count %>
                    <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </span>
                </div>
                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button @click="editing = true" class="p-1.5 text-gray-400 hover:text-blue-600 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                  </button>
                  <%= button_to admin_destroy_segmentation_item_path(item), method: :delete, data: { confirm: '¿Estás seguro de eliminar este item?' }, class: "p-1.5 text-gray-400 hover:text-red-600 transition-colors" do %>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  <% end %>
                </div>
              </div>
              
              <div x-show="editing" class="p-3 border-2 border-blue-500 rounded-lg">
                <%= form_with url: admin_update_segmentation_item_path(item), method: :patch, class: "flex items-center space-x-2" do |f| %>
                  <%= f.text_field :name, value: item.name, 'x-model': 'name', class: "flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500", placeholder: "Nombre del item" %>
                  <button type="submit" class="p-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                  </button>
                  <button @click="editing = false" type="button" class="p-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <button @click="editingItem = 'new'" x-show="editingItem !== 'new'" class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-sm text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-colors flex items-center justify-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Agregar ítem
          </button>
          
          <div x-show="editingItem === 'new'" class="p-3 border-2 border-blue-500 rounded-lg bg-blue-50">
            <%= form_with url: admin_create_segmentation_item_path(segmentation), method: :post, class: "flex items-center space-x-2" do |f| %>
              <%= f.text_field :name, 'x-model': 'newItemName', class: "flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white", placeholder: "Nombre del item", required: true %>
              <button type="submit" class="p-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </button>
              <button @click="editingItem = null; newItemName = ''" type="button" class="p-2 text-gray-600 bg-white rounded-lg hover:bg-gray-100">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
